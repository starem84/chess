<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Échecs face-à-face — Final</title>
<style>
  :root {
    --square: 78px;
    --piece: 66px;
    --clock-w: 120px;
  }
  body {
    display: flex; justify-content: center; margin: 16px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  .menu { display: flex; flex-direction: column; gap: 10px; align-items: center; }
  .menu h2 { margin: 8px 0 2px; }
  .menu p { margin: 0 0 10px; font-size: 14px; color: #555; }
  .menu button {
    padding: 10px 18px; font-size: 18px; cursor: pointer;
    border-radius: 10px; border: 1px solid #666; background: #eee;
  }
  .game { display: none; align-items: center; gap: 16px; }
  .side {
  width: var(--clock-w);
  display: flex;
  align-items: center;
  justify-content: center;
}
.panel {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
#blackClock { transform: rotate(180deg); }
#blackScore { transform: rotate(180deg); }

  .clock {
    width: 100%; text-align: center; font-size: 26px; font-weight: 800;
    padding: 10px 8px; border: 2px solid #333; border-radius: 12px;
  }
  #whiteClock { background: #fff; color: #000; }
  #blackClock { background: #000; color: #fff; transform: rotate(180deg); }
  .score { margin-top: 8px; font-size: 14px; font-weight: 600; color: #333; }
  #blackScore { transform: rotate(180deg); }
  table { border-collapse: collapse; }
  td {
    width: var(--square); height: var(--square);
    text-align: center; vertical-align: middle; user-select: none;
  }
  .white { background: #f0d9b5; }
  .black { background: #b58863; }
  img.piece { width: var(--piece); height: var(--piece); pointer-events: none; }
  .rotated { transform: rotate(180deg); }
  .selected { outline: 3px solid #ffd400; }
  .move-option { outline: 3px solid #00ccff; }
  .castle-option { outline: 3px solid #00cc00; }
</style>
</head>
<body>

<div id="menu" class="menu">
  <h2>Choisissez la durée</h2>
  <p>(les Blancs jouent en premier, la pendule démarre au premier coup)</p>
  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
    <button onclick="startGame(1)">1 min</button>
    <button onclick="startGame(5)">5 min</button>
    <button onclick="startGame(10)">10 min</button>
    <button onclick="startGame(15)">15 min</button>
  </div>
</div>

<div id="game" class="game">
  <div class="side">
    <div class="panel">
      <div id="blackScore" class="score">Matériel: 0</div>
      <div id="blackClock" class="clock">00:00</div>
    </div>
  </div>
  <table id="board"></table>
  <div class="side">
    <div class="panel">
      <div id="whiteClock" class="clock">00:00</div>
      <div id="whiteScore" class="score">Matériel: 0</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js"></script>
<script>
const PIECES = {
  "P": "https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg",
  "R": "https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg",
  "N": "https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg",
  "B": "https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg",
  "Q": "https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg",
  "K": "https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg",
  "p": "https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg",
  "r": "https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg",
  "n": "https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg",
  "b": "https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg",
  "q": "https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg",
  "k": "https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg"
};

const chess = new Chess();
const board = document.getElementById("board");
let selected=null, legalMoves=[], castleMoves={};
let whiteTime=0, blackTime=0, baseTime=0;
let turn="w", timer=null, gameStarted=false, gameOver=false;

/* Pendules */
function formatTime(sec){ const m=Math.floor(sec/60).toString().padStart(2,"0"); const s=(sec%60).toString().padStart(2,"0"); return `${m}:${s}`; }
function updateClocks(){ document.getElementById("whiteClock").textContent=formatTime(whiteTime); document.getElementById("blackClock").textContent=formatTime(blackTime); }
function startTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ if(gameOver){clearInterval(timer);return;} if(turn==="w"){whiteTime--;if(whiteTime<=0){whiteTime=0;updateClocks();timeOut("w");return;}} else {blackTime--;if(blackTime<=0){blackTime=0;updateClocks();timeOut("b");return;}} updateClocks();},1000);}
function timeOut(side){ clearInterval(timer); gameOver=true; const winner=(side==="w"?"Noirs":"Blancs"); alert(`Temps écoulé : ${winner} gagnent !`); }

/* Plateau */
function toSquare(i,j){ const f="abcdefgh"; return f[j]+(8-i); }
function buildBoard(){ board.innerHTML=""; for(let i=0;i<8;i++){ const tr=document.createElement("tr"); for(let j=0;j<8;j++){ const td=document.createElement("td"); td.className=((i+j)%2===0)?"white":"black"; td.dataset.row=i; td.dataset.col=j; td.addEventListener("click",onCellClick); tr.appendChild(td);} board.appendChild(tr);} }
function drawBoard(){
  for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
      const td=board.rows[i].cells[j];
      td.innerHTML="";
      td.classList.remove("selected","move-option","castle-option");
      const sq=toSquare(i,j);
      if(selected===sq) td.classList.add("selected");
      if(legalMoves.includes(sq)) td.classList.add("move-option");
      if(castleMoves.includes(sq)) td.classList.add("castle-option");
      const piece=chess.get(sq);
      if(piece){
        const img=document.createElement("img");
        const key=(piece.color==="w"?piece.type.toUpperCase():piece.type);
        img.src=PIECES[key];
        img.className="piece"+(piece.color==="b"?" rotated":"");
        td.appendChild(img);
      }
    }
  }
  updateMaterialScores();
}

/* Score matériel différentiel */
const pieceVals={p:1,n:3,b:3,r:5,q:9,k:0};
function evaluateMaterial(){ let w=0,b=0; for(const sq of chess.SQUARES){ const p=chess.get(sq); if(!p) continue; if(p.color==="w") w+=pieceVals[p.type]; else b+=pieceVals[p.type]; } return {w,b}; }
function updateMaterialScores(){ const {w,b}=evaluateMaterial(); const diffW=w-b; const diffB=b-w; document.getElementById("whiteScore").textContent="Matériel: "+(diffW>0? "+"+diffW: diffW); document.getElementById("blackScore").textContent="Matériel: "+(diffB>0? "+"+diffB: diffB); }

/* Clic */
function onCellClick(e){
  if(gameOver) return;
  const r=parseInt(e.currentTarget.dataset.row,10), c=parseInt(e.currentTarget.dataset.col,10);
  const sq=toSquare(r,c);

  if(selected){
    const mv=chess.move({from:selected,to:sq,promotion:"q"});
    if(mv){
      if(!gameStarted){ gameStarted=true; turn="b"; startTimer(); }
      else { turn=(turn==="w"?"b":"w"); startTimer(); }
      selected=null; legalMoves=[]; castleMoves=[]; drawBoard();
      if(chess.in_checkmate()){ clearInterval(timer); gameOver=true; alert("Échec et mat !"); return; }
      else if(chess.in_draw()){ clearInterval(timer); gameOver=true; alert("Partie nulle !"); return; }
      return;
    }
  }

  const piece=chess.get(sq);
  const trait=gameStarted?turn:"w";
  if(piece && piece.color===trait){
    selected=sq;
    const moves=chess.moves({square:sq,verbose:true});
    legalMoves=moves.map(m=>m.to);
    castleMoves=[];
    for(const m of moves){
      if(m.san==="O-O" || m.san==="O-O-O"){ castleMoves.push(m.to); }
    }
  } else {
    selected=null; legalMoves=[]; castleMoves=[];
  }
  drawBoard();
}

/* Start */
function startGame(minutes){
  document.getElementById("menu").remove();
  document.getElementById("game").style.display="flex";
  baseTime=minutes*60;
  whiteTime=baseTime; blackTime=baseTime;
  updateClocks();
  buildBoard();
  selected=null; legalMoves=[]; castleMoves=[]; // <-- s’assurer qu’on part de zéro
  drawBoard(); // <-- affiche tout de suite les pièces de départ
}

</script>
</body>
</html>
